"use strict";function handleCmeIframeMessage(e){var t,s,i,n,a,r,o;if(t=window.location.href,!/https?:\/\/(?:dev|localhost:3000|tree\.mediaengagement\.org|enptree(\.staging)?\.wpengine\.com)\b/.test(e.origin))return console.error("Domain not allowed.",e.origin),!1;if("string"!=typeof e.data)return console.error("Data is not a string."),!1;if(i=JSON.parse(e.data),n="cme-tree__"+i.tree_id,a=document.getElementById(n),s={iframe:a,parentURL:t,treeID:i.tree_id},0===cmeTreeIframes.length)cmeTreeIframes.push(new CmeIframeTree(s)),r=cmeTreeIframes[0];else{o=!1;for(var m=0;m<cmeTreeIframes.length;m++)cmeTreeIframes[m].iframeID===a.id&&(r=cmeTreeIframes[m],o=!0);!1===o&&(cmeTreeIframes.push(new CmeIframeTree(s)),r=cmeTreeIframes[cmeTreeIframes.length-1])}r.receiveIframeMessage(e.origin,i)}function CmeIframeTree(e){this.iframe=e.iframe,console.log(e.iframe),this.iframeID=e.iframe.id,this.quizID=e.quizID,this.abTestID=e.abTestID,this.parentURL=e.parentURL,this.siteName=this.setSiteName(),this.saveEmbedSiteComplete=!1,this.saveEmbedQuizComplete=!1,this.embedSiteID=!1,this.embedQuizID=!1,this.onLoadIframe()}var cmeTreeIframes=[];window.addEventListener("message",handleCmeIframeMessage,!1),document.onreadystatechange=function(){var e=void 0,t=void 0;if("complete"===document.readyState){e=document.getElementsByClassName("cme-tree__iframe");for(var s=0;s<e.length;++s)t='{"status":"request","action":"init"}',console.log("sending init",t),e[s].contentWindow.postMessage(t,e[s].src)}},CmeIframeTree.prototype={constructor:CmeIframeTree,getSaveEmbedSiteComplete:function(){return this.saveEmbedSiteComplete},setSaveEmbedSiteComplete:function(e){"boolean"==typeof e&&(this.saveEmbedSiteComplete=e)},getSaveEmbedQuizComplete:function(){return this.saveEmbedQuizComplete},setSaveEmbedQuizComplete:function(e){"boolean"==typeof e&&(this.saveEmbedQuizComplete=e)},setSiteName:function(e){return e=this.getFBSiteNameMeta(),this.siteName=e&&"string"==typeof e?e:this.parentURL,this.siteName},getSiteName:function(){return this.siteName},getFBSiteNameMeta:function(){var e=document.querySelector('meta[property="og:site_name"]');return!!e&&e.content},receiveIframeMessage:function(e,t){var s;return s={},console.log("parent recieved message",t),"setHeight"===t.action?s.setQuizHeight=this.setQuizHeight(t.height):"scrollToQuiz"===t.action||"quizRestarted"===t.action?s.scrollToQuizResponse=this.scrollToQuiz():"sendURL"===t.action?s.sendParentURLResponse=this.sendParentURL():"saveSite"===t.action&&this.saveEmbedSite(e,t,this.handleEmbedSiteResponse,this),s},onLoadIframe:function(){this.addIframeStyles(),this.getQuizHeight(),this.sendParentURL(),this.sendSaveSite()},getQuizHeight:function(){var e;e='{"status":"request","action":"sendBodyHeight"}',this.iframe.contentWindow.postMessage(e,this.iframe.src)},sendSaveSite:function(){var e;e='{"status":"request","action":"sendSaveSite"}',this.iframe.contentWindow.postMessage(e,this.iframe.src)},sendParentURL:function(){var e;if(/https?:\/\/(?:local.quiz|(?:(?:local|dev|test)\.)?engagingnewsproject\.org|(?:engagingnews|enpdev)\.(?:staging\.)?wpengine\.com)\/enp-quiz\/quiz-preview\/\d+\b/.test(this.parentURL))return!1;e='{"status":"request","action":"setShareURL","parentURL":"'+this.parentURL+'"}',this.iframe.contentWindow.postMessage(e,this.iframe.src)},setQuizHeight:function(e){return!!/([0-9])px/.test(e)&&(this.iframe.style.height=e,e)},scrollToQuiz:function(){var e=!1,t=this.iframe.getBoundingClientRect().top;return-20<t&&t<100?e="noScroll":(scrollBy(0,t-10),e="scrolledTop"),e},addIframeStyles:function(){var e=".cme-tree__iframe { -webkit-transition: all .25s ease-in-out;transition: all .25s ease-in-out; }",t=document.head||document.getElementsByTagName("head")[0],s=document.createElement("style");s.type="text/css",s.styleSheet?s.styleSheet.cssText=e:s.appendChild(document.createTextNode(e)),t.appendChild(s)},serialize:function(e){var t="";for(var s in e)t+=s+"="+e[s]+"&";return t=t.slice(0,t.length-1)},saveEmbedSite:function(e,t,s,i){if(!0===this.getSaveEmbedSiteComplete())return!1;var n,a=new XMLHttpRequest;a.open("POST",e+"/wp-content/plugins/enp-quiz/database/class-enp_quiz_save_embed.php"),a.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),a.onreadystatechange=function(){a.readyState===XMLHttpRequest.DONE&&200===a.status?(i.setSaveEmbedSiteComplete(!0),n=JSON.parse(a.responseText),"success"===n.status?(n.origin=e,n.quiz_id=t.quiz_id,"function"==typeof s&&s(n,i)):console.log("XHR request for saveEmbedSite successful but returned response error: "+JSON.stringify(n))):200!==a.status&&console.log("Request failed.  Returned status of "+a.status)},t.embed_site_url=this.parentURL,t.embed_site_name=this.getSiteName(),t.save="embed_site",t.action="insert",t.doing_ajax="true",a.send(encodeURI(this.serialize(t)))},handleEmbedSiteResponse:function(e,t){if(t.embedSiteID=e.embed_site_id,0<parseInt(t.embedSiteID))return t.saveEmbedQuiz(e,t.handleEmbedQuizResponse,t),e;console.log("Could't locate a valid Embed Site")},saveEmbedQuiz:function(e,t,s){if(!0===this.getSaveEmbedQuizComplete())return!1;var i,n=new XMLHttpRequest;n.open("POST",e.origin+"/wp-content/plugins/enp-quiz/database/class-enp_quiz_save_embed.php"),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){n.readyState===XMLHttpRequest.DONE&&200===n.status?(s.setSaveEmbedQuizComplete(!0),i=JSON.parse(n.responseText),"success"===i.status?"function"==typeof t&&t(i,s):console.log("XHR request for saveEmbedQuiz successful but returned response error: "+JSON.stringify(i))):200!==n.status&&console.log("Request failed.  Returned status of "+n.status)},embed_quiz={save:"embed_quiz",embed_site_id:e.embed_site_id,quiz_id:e.quiz_id,embed_quiz_url:this.parentURL,doing_ajax:"true"},n.send(encodeURI(this.serialize(embed_quiz)))},handleEmbedQuizResponse:function(e,t){if(t.embedQuizID=e.embed_quiz_id,0<parseInt(t.embedQuizID))return e;console.log("Could't locate a valid Embed Quiz")}};