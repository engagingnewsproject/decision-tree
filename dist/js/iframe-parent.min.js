"use strict";function handleCmeIframeMessage(e){var t,s,r,n,i,a,o;if(t=window.location.href,!/https?:\/\/(?:dev|localhost:3000|tree\.mediaengagement\.org|enptree(\.staging)?\.wpengine\.com)\b/.test(e.origin))return console.error("Domain not allowed.",e.origin),!1;if("string"!=typeof e.data)return console.error("Data is not a string."),!1;if(r=JSON.parse(e.data),n="cme-tree__"+r.tree_id,i=document.getElementById(n),s={iframe:i,parentURL:t,treeID:r.tree_id},0===cmeTreeIframes.length)cmeTreeIframes.push(new CmeIframeTree(s)),a=cmeTreeIframes[0];else{o=!1;for(var m=0;m<cmeTreeIframes.length;m++)cmeTreeIframes[m].iframeID===i.id&&(a=cmeTreeIframes[m],o=!0);!1===o&&(cmeTreeIframes.push(new CmeIframeTree(s)),a=cmeTreeIframes[cmeTreeIframes.length-1])}a.receiveIframeMessage(e.origin,r)}function CmeIframeTree(e){this.iframe=e.iframe,this.iframeID=e.iframe.id,this.treeID=e.treeID,this.parentURL=e.parentURL,this.siteName=this.setSiteName(),this.saveEmbedSiteComplete=!1,this.saveEmbedTreeComplete=!1,this.embedSiteID=!1,this.embedTreeID=!1,this.onLoadIframe()}var cmeTreeIframes=[];window.addEventListener("message",handleCmeIframeMessage,!1),document.onreadystatechange=function(){var e=void 0,t=void 0;if("complete"===document.readyState){e=document.getElementsByClassName("cme-tree__iframe");for(var s=0;s<e.length;++s)t='{"status":"request","action":"init"}',console.log("sending init",t),e[s].contentWindow.postMessage(t,e[s].src)}},CmeIframeTree.prototype={constructor:CmeIframeTree,getSaveEmbedSiteComplete:function(){return this.saveEmbedSiteComplete},setSaveEmbedSiteComplete:function(e){"boolean"==typeof e&&(this.saveEmbedSiteComplete=e)},getSaveEmbedTreeComplete:function(){return this.saveEmbedTreeComplete},setSaveEmbedTreeComplete:function(e){"boolean"==typeof e&&(this.saveEmbedTreeComplete=e)},setSiteName:function(e){return e=this.getFBSiteNameMeta(),this.siteName=e&&"string"==typeof e?e:this.parentURL,this.siteName},getSiteName:function(){return this.siteName},getFBSiteNameMeta:function(){var e=document.querySelector('meta[property="og:site_name"]');return!!e&&e.content},receiveIframeMessage:function(e,t){var s;return s={},console.log("parent recieved message",t),"treeHeight"===t.action?s.setTreeHeight=this.setTreeHeight(t.treeHeight):"update"===t.action&&"forceCurrentState"!==t.data.updatedBy?s.scrollToQuizResponse=this.scrollToQuiz():"sendURL"===t.action?s.sendParentURLResponse=this.sendParentURL():"saveSite"===t.action&&this.saveEmbedSite(e,t,this.handleEmbedSiteResponse,this),s},onLoadIframe:function(){this.addIframeStyles(),this.getQuizHeight(),this.sendParentURL(),this.sendSaveSite()},getQuizHeight:function(){var e;e='{"status":"request","action":"sendBodyHeight"}',this.iframe.contentWindow.postMessage(e,this.iframe.src)},sendSaveSite:function(){var e;e='{"status":"request","action":"sendSaveSite"}',this.iframe.contentWindow.postMessage(e,this.iframe.src)},sendParentURL:function(){var e;if(/https?:\/\/(?:local.quiz|(?:(?:local|dev|test)\.)?engagingnewsproject\.org|(?:engagingnews|cmedev)\.(?:staging\.)?wpengine\.com)\/cme-quiz\/quiz-preview\/\d+\b/.test(this.parentURL))return!1;e='{"status":"request","action":"setShareURL","parentURL":"'+this.parentURL+'"}',this.iframe.contentWindow.postMessage(e,this.iframe.src)},setTreeHeight:function(e){return console.log(e),this.iframe.style.height=e+"px",e},scrollToQuiz:function(){var e=!1,t=this.iframe.getBoundingClientRect().top;return-20<t&&t<100?e="noScroll":(scrollBy(0,t-10),e="scrolledTop"),e},addIframeStyles:function(){var e=".cme-tree__iframe { -webkit-transition: all .3s ease-in-out;transition: all .3s ease-in-out; }",t=document.head||document.getElementsByTagName("head")[0],s=document.createElement("style");s.type="text/css",s.styleSheet?s.styleSheet.cssText=e:s.appendChild(document.createTextNode(e)),t.appendChild(s)},saveEmbedSite:function(e,t,s,r){if(!0===this.getSaveEmbedSiteComplete())return!1;var n,i=new XMLHttpRequest;i.open("POST",e+"/sites/new"),i.setRequestHeader("Content-Type","application/json;charset=UTF-8"),i.onreadystatechange=function(){i.readyState===XMLHttpRequest.DONE&&200===i.status?(r.setSaveEmbedSiteComplete(!0),n=JSON.parse(i.responseText),"success"===n.status?(n.origin=e,n.tree_id=t.tree_id,"function"==typeof s&&s(n,r)):console.log("XHR request for saveEmbedSite successful but returned response error: "+JSON.stringify(n))):200!==i.status&&console.log("Request failed.  Returned status of "+i.status)},t.embed_site_url=this.parentURL,t.embed_site_name=this.getSiteName(),i.send(JSON.stringify(t))},handleEmbedSiteResponse:function(e,t){if(t.embedSiteID=e.embed_site_id,0<parseInt(t.embedSiteID))return t.saveEmbedTree(e,t.handleEmbedTreeResponse,t),e;console.log("Could't locate a valid Embed Site")},saveEmbedTree:function(e,t,s){if(!0===this.getSaveEmbedTreeComplete())return!1;var r,n=new XMLHttpRequest;n.open("POST",e.origin+"/sites/"+e.embed_site_id+"/embed/new"),n.setRequestHeader("Content-Type","application/json;charset=UTF-8"),n.onreadystatechange=function(){n.readyState===XMLHttpRequest.DONE&&200===n.status?(s.setSaveEmbedTreeComplete(!0),r=JSON.parse(n.responseText),"success"===r.status?"function"==typeof t&&t(r,s):console.log("XHR request for saveEmbedTree successful but returned response error: "+JSON.stringify(r))):200!==n.status&&console.log("Request failed.  Returned status of "+n.status)},embed_tree={tree_id:e.tree_id,embed_tree_url:this.parentURL},n.send(JSON.stringify(embed_tree))},handleEmbedTreeResponse:function(e,t){if(t.embedTreeID=e.embed_tree_id,0<parseInt(t.embedTreeID))return e;console.log("Could't locate a valid Embed Quiz")}};