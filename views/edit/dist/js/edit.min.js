"use strict";var treeServer=axios.create({baseURL:window.location.origin+"/api/v1",timeout:1e3,headers:{"X-API-Access":localStorage.getItem("accessToken"),"X-API-Client":localStorage.getItem("clientToken")}}),app=new Vue({el:"#app",data:function(){return{trees:[],currentTree:void 0,errored:!1,loading:!0,elTypes:["question","end","start","group","option"],addOption:!1,newEl:{question:{title:null},option:{questionID:null,title:null,destination:""},end:{title:null,content:null}},sort:{sorting:{elType:null,from:null,to:null,el:null},sortables:[],whitelist:["question"]}}},mounted:function(){this.reMount()},methods:{reMount:function(){var o=this;this.loading=!0;var r=window.scrollY;treeServer.get("/trees/"+tree.ID+"/compiled?stats=false").then(function(t){var e=t.data;if(o.trees.push(t.data),1===o.trees.length){var n=Object.assign({},e);o.trees.push(JSON.parse(JSON.stringify(n)))}o.currentTree=o.trees[o.trees.length-1]}).catch(function(t){console.error(t),o.errored=!0}).finally(function(){o.loading=!1,o.$nextTick(function(){for(var t=0;t<this.sort.whitelist.length;t++)this.setupSortable(this.sort.whitelist[t]);window.scrollTo(0,r);for(var e={},n=document.querySelectorAll("textarea"),o=0;o<n.length;o++)e.target=n[o],this.setTextareaHeight(e)})})},saveTree:function(){var e=this;treeServer.put("/trees/"+this.currentTree.ID,{title:this.currentTree.title,slug:this.currentTree.slug}).then(function(t){return console.log(t.data)}).catch(function(t){console.log(t),e.errored=!0})},saveElement:function(t,e){var n,o,r=this,i=void 0,s=void 0,l=void 0,u=void 0,a=void 0;a=this.trees[this.trees.length-2],s="option"!==e?(i=a[e+"s"])[this.getIndexBy(i,"ID",t)]:this.getOption(t,a),o=this.buildSave(s),console.log(o),a=this.currentTree,s="option"!==e?(i=a[e+"s"])[this.getIndexBy(i,"ID",t)]:this.getOption(t,a),n=this.buildSave(s),console.log(n),this.areObjectsEqual(n,o)?console.log("no changes"):(l="/trees/"+a.ID+"/"+e+"s/"+t,"option"===e&&(u=this.getQuestionByOption(t),l="/trees/"+a.ID+"/questions/"+u.ID+"/options/"+t),treeServer.put(l,n).then(function(t){return console.log(t.data)}).catch(function(t){console.log(t),r.errored=!0}).finally(function(){return r.reMount()}))},deleteElement:function(t,e){var n,o,r=this;alert("Are you sure? This will delete the "+e+"."),n="/trees/"+tree.ID+"/"+e+"s/"+t,"option"===e&&(o=this.getQuestionByOption(t),n="/trees/"+tree.ID+"/questions/"+o.ID+"/options/"+t),treeServer.delete(n).then(function(t){return console.log(t.data)}).catch(function(t){console.log(t),r.errored=!0}).finally(function(){return r.reMount()})},createElement:function(t){var e=this,n="/trees/"+tree.ID+"/"+t+"s";"option"===t&&(n="/trees/"+tree.ID+"/questions/"+this.newEl.option.questionID+"/options"),treeServer.post(n,this.newEl[t]).then(function(t){return console.log(t.data)}).catch(function(t){console.log(t),e.errored=!0}).finally(function(){e.newEl[t].title=null,e.newEl[t].content=null,e.newEl[t].questionID=null,e.newEl[t].destination=null,e.reMount()})},buildSave:function(t){for(var e={},n=["title","content","questionID","destination","destinationID","questions"],o=0;o<n.length;o++)n[o]in t&&(e[n[o]]=t[n[o]],"destinationID"!==n[o]&&"destination"!==n[o]||(e.destinationType=this.getDestinationTypeByID(t[n[o]]),console.log("finding destination of ",t[n[o]]),console.log("destinationType",e.destinationType)));return e},createOption:function(t){this.newEl.option.questionID=t,this.createElement("option"),this.toggleAddOption()},setupSortable:function(o){var r=this,t="."+o+"s",e=document.querySelectorAll(t);if(0===e.length)return console.log("no sortable found for "+o),!1;this.sort.sortables[o]=new Sortable.default(e,{draggable:"."+o,appendTo:t,mirror:{constrainDimensions:!0}}),this.sort.sortables[o].on("drag:start",function(t){"DIV"!==document.activeElement.nodeName&&t.cancel(),r.sort.sorting.elType=o,r.sort.sorting.from=r.getElementIndex(t.data.source),r.sort.sorting.el=r.currentTree[o+"s"][r.sort.sorting.from]}),this.sort.sortables[o].on("drag:stop",function(t){r.sort.sorting.to=r.getElementIndex(t.data.source);var e=r.sort.sorting.to,n=r.sort.sorting.from;e!==n&&(n<e&&(e-=1),r.orderSave(o,r.sort.sorting.el,e)),r.sort.sorting.elType=null,r.sort.sorting.from=null,r.sort.sorting.to=null,r.sort.sorting.el=null})},orderSave:function(t,e,n){var o=this,r="/trees/"+tree.ID+"/"+t+"s/"+e.ID+"/move/"+n;if("option"===t){var i=this.getQuestionByOption(e.ID);r="/trees/"+tree.ID+"/questions/"+i.ID+"/options/"+e.ID+"/move/"+n}treeServer.put(r).then(function(t){return console.log(t.data)}).catch(function(t){console.log(t),o.errored=!0}).finally(function(){return o.reMount()})},setTextareaHeight:function(t){t.target.style.height=t.target.scrollHeight+"px"},toggleAddOption:function(t){this.addOption=t},getElementIndex:function(t){for(var e=0;t=t.previousElementSibling;)e++;return e},getOption:function(t,e){void 0===e&&(e=this.currentTree);var n,o=void 0;n=e.questions;for(var r=0;r<n.length;r++)if(void 0!==(o=this.getIndexBy(n[r].options,"ID",t)))return n[r].options[o]},getQuestionByOption:function(t){var e;e=this.currentTree.questions;for(var n=0;n<e.length;n++)if(void 0!==this.getIndexBy(e[n].options,"ID",t))return e[n]},getDestinationTypeByID:function(t){var e,n;e=this.currentTree.questions;for(var o=0;o<e.length;o++)if(e[o].ID===t)return"question";n=this.currentTree.ends;for(var r=0;r<n.length;r++)if(n[r].ID===t)return"end"},getIndexBy:function(t,e,n){for(var o=0;o<t.length;o++)if(t[o][e]==n)return o},areObjectsEqual:function(t,e){var n=Object.getOwnPropertyNames(t),o=Object.getOwnPropertyNames(e);if(n.length!=o.length)return!1;for(var r=0;r<n.length;r++){var i=n[r];if(t[i]!==e[i])return!1}return!0}}});